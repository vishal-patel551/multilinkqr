<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Opening your links – MultiLinkQR</title>
    <meta name="description" content="Landing page for MultiLinkQR. Automatically opens multiple links from a single QR code scan.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .brand-logo {
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .preview-card {
            border-radius: 0.75rem;
            border: 1px solid #dee2e6;
            padding: 0.75rem 1rem;
            background: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .preview-favicon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            flex-shrink: 0;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            background: #ffffff;
            border-top: 1px solid #e5e5e5;
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container">
            <a class="navbar-brand brand-logo" href="index.html">
                <span class="text-primary">Multi</span>LinkQR
            </a>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body p-4 p-md-5">
                        <h1 id="pageTitle" class="h4 mb-2">Opening your links...</h1>
                        <p id="statusArea" class="text-muted mb-3">
                            Trying to open all your links in new tabs. If your browser blocks popups, you can click the buttons below.
                        </p>

                        <div id="errorArea"></div>

                        <div id="expiredMessage" class="alert alert-warning d-none">
                            This QR code has expired. Please contact the owner for a new code.
                        </div>

                        <div id="controls" class="mt-3 mb-3 d-none">
                            <label class="form-label fw-semibold me-2">View:</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" id="btnViewOpen">Open all links</button>
                                <button type="button" class="btn btn-outline-primary" id="btnViewButtons">Buttons</button>
                                <button type="button" class="btn btn-outline-primary" id="btnViewPreview">Preview cards</button>
                            </div>
                        </div>

                        <div id="buttonsView" class="mt-3 d-none"></div>
                        <div id="previewView" class="mt-3 d-none"></div>

                        <div class="mt-4">
                            <a href="generator.html" class="btn btn-outline-secondary btn-sm">
                                Create your own multi-link QR
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container d-flex flex-wrap justify-content-between align-items-center">
            <div>© <span id="yearSpan"></span> MultiLinkQR – Multi-link QR code generator.</div>
            <div>
                <a href="privacy-policy.html" class="me-3">Privacy Policy</a>
                <a href="terms.html">Terms</a>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function getParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        function showError(message) {
            $("#errorArea").html(
                '<div class="alert alert-danger" role="alert">' + message + '</div>'
            );
        }

        function validateHttps(url) {
            return /^https:\/\/.+/i.test(url.trim());
        }

        function getDomain(url) {
            try {
                const u = new URL(url);
                return u.hostname;
            } catch (e) {
                return url;
            }
        }

        function createFaviconUrl(url) {
            try {
                const u = new URL(url);
                return u.origin + "/favicon.ico";
            } catch (e) {
                return null;
            }
        }

        function renderButtons(links, primaryColor) {
            const container = $("#buttonsView");
            container.empty();
            links.forEach(function (item, idx) {
                const label = item.label || ("Link " + (idx + 1));
                container.append(
                    '<a href="' + item.url + '" target="_blank" rel="noopener noreferrer"' +
                    ' class="btn btn-primary w-100 mb-2" style="background-color:' + primaryColor + ';border-color:' + primaryColor + '">' +
                    label +
                    '</a>'
                );
            });
        }

        function renderPreviewCards(links) {
            const container = $("#previewView");
            container.empty();
            links.forEach(function (item, idx) {
                const label = item.label || ("Link " + (idx + 1));
                const domain = getDomain(item.url);
                const favicon = createFaviconUrl(item.url);
                const firstLetter = (domain && domain[0]) ? domain[0].toUpperCase() : "?";

                const faviconHtml = favicon
                    ? '<img src="' + favicon + '" alt="icon" onerror="this.style.display=\'none\'" style="width:24px;height:24px;border-radius:6px;">'
                    : '<span>' + firstLetter + '</span>';

                container.append(
                    '<div class="preview-card">' +
                    '<div class="preview-favicon">' + faviconHtml + '</div>' +
                    '<div>' +
                    '<div class="fw-semibold">' + label + '</div>' +
                    '<div class="small text-muted">' +
                    '<a href="' + item.url + '" target="_blank" rel="noopener noreferrer">' + item.url + '</a>' +
                    '</div>' +
                    '</div>' +
                    '</div>'
                );
            });
        }

        function openAllLinks(links) {
            links.forEach(function (item) {
                window.open(item.url, "_blank");
            });
        }

        $(function () {
            $("#yearSpan").text(new Date().getFullYear());

            const encoded = getParam("d");
            if (!encoded) {
                showError("No data found in the URL. Please scan a valid QR code or use the correct link.");
                $("#statusArea").text("Unable to open links.");
                return;
            }

            let payload;
            try {
                const jsonStr = decodeURIComponent(escape(atob(encoded)));
                payload = JSON.parse(jsonStr);
            } catch (e) {
                console.error(e);
                showError("The data in the URL is invalid or corrupted.");
                $("#statusArea").text("Unable to open links.");
                return;
            }

            const links = (payload && Array.isArray(payload.links)) ? payload.links.filter(l => validateHttps(l.url)) : [];

            if (links.length === 0) {
                showError("No valid https links found in the QR data.");
                $("#statusArea").text("Unable to open links.");
                return;
            }

            const now = Date.now();
            if (payload.exp && now > payload.exp) {
                $("#expiredMessage").removeClass("d-none");
                $("#statusArea").text("This QR code is expired.");
                return;
            }

            const title = payload.title || "Your links are ready";
            $("#pageTitle").text(title);

            const style = payload.style || {};
            const primaryColor = style.color || "#0d6efd";
            const bg = style.bg || "#f8f9fa";

            $("body").css("background-color", bg === "#000000" ? "#000000" : "#f8f9fa");

            $("#controls").removeClass("d-none");
            $("#buttonsView").removeClass("d-none");

            renderButtons(links, primaryColor);
            renderPreviewCards(links);

            const mode = payload.mode || "auto";

            if (mode === "auto") {
                $("#statusArea").text("Trying to open all links in new tabs. If blocked, use the buttons below.");
                openAllLinks(links);
            } else {
                $("#statusArea").text("Use the buttons below to open your links.");
            }

            $("#btnViewOpen").on("click", function () {
                openAllLinks(links);
            });
            $("#btnViewButtons").on("click", function () {
                $("#buttonsView").removeClass("d-none");
                $("#previewView").addClass("d-none");
            });
            $("#btnViewPreview").on("click", function () {
                $("#previewView").removeClass("d-none");
                $("#buttonsView").addClass("d-none");
            });
        });
    </script>
</body>
</html>